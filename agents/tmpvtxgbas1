import os
import pandas as pd

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
CSV_PATH = os.path.join(BASE_DIR, "..", "knowledge_base", "product_info_slim.csv")

print(f"[Recommender] Loading product CSV from: {CSV_PATH}")

df = pd.read_csv(CSV_PATH)

df = df[[
    "brand_name",
    "product_name",
    "ingredients",
    "price_usd",
    "highlights",
    "primary_category",
    "secondary_category",
    "tertiary_category"
]]

df["highlights_lower"] = df["highlights"].fillna("").str.lower()
df["ingredients_lower"] = df["ingredients"].fillna("").str.lower()


def recommender_agent(filters):
    print("[Recommender Agent] Selecting products with scoring...")

    skin_type    = (filters.get("skin_type") or "").lower()
    product_type = (filters.get("product_type") or "").lower()

    # ðŸ”¹ CAMBIO: ahora usamos min_price y max_price en lugar de budget
    min_price = float(filters.get("min_price") or 0)
    max_price = float(filters.get("max_price") or 0)

    # ðŸ”¹ Main concerns puede ser lista (1â€“3)
    main_concerns = filters.get("main_concerns") or []
    if isinstance(main_concerns, str):
        main_concerns = [main_concerns]
    main_concerns = [c.lower() for c in main_concerns if c]

    age_range       = (filters.get("age_range") or "").lower()
    needs_sensitive = bool(filters.get("needs_sensitive") or False)

    filtered_df = df.copy()

    # ---------- Filtros DUROS ----------

    # Product Type
    if product_type:
        mask_type = (
            filtered_df["primary_category"].fillna("").str.lower().str.contains(product_type) |
            filtered_df["secondary_category"].fillna("").str.lower().str.contains(product_type) |
            filtered_df["tertiary_category"].fillna("").str.lower().str.contains(product_type)
        )
        filtered_df = filtered_df[mask_type]

    # ðŸ”¹ Filtro por rango de precios
    if min_price > 0:
        filtered_df = filtered_df[filtered_df["price_usd"] >= min_price]

    if max_price > 0:
        filtered_df = filtered_df[filtered_df["price_usd"] <= max_price]

    if filtered_df.empty:
        return [
            "No skincare products matched your filters.",
            "Tip: Try increasing your budget or changing the product type."
        ]

    # ---------- Scoring ----------
    filtered_df["score"] = 0

    # +2 â†’ Skin type match
    if skin_type:
        mask_skin = filtered_df["highlights_lower"].str.contains(skin_type)
        filtered_df.loc[mask_skin, "score"] += 2

    # +2 â†’ Main concern (pueden ser varias)
    if main_concerns:
        for concern in main_concerns:
            mask_c = (
                filtered_df["highlights_lower"].str.contains(concern) |
                filtered_df["ingredients_lower"].str.contains(concern)
            )
            filtered_df.loc[mask_c, "score"] += 2

    # +1 â†’ Price â‰¤ 80% del â€œbudgetâ€ (usamos max_price como referencia)
    if max_price > 0:
        mask_cheap = filtered_df["price_usd"] <= max_price * 0.8
        filtered_df.loc[mask_cheap, "score"] += 1

    # +1 â†’ Age range o â€œall agesâ€
    if age_range:
        mask_age = (
            filtered_df["highlights_lower"].str.contains(age_range) |
            filtered_df["highlights_lower"].str.contains("all ages")
        )
        filtered_df.loc[mask_age, "score"] += 1

    # +1 â†’ Suitable for sensitive skin
    if needs_sensitive:
        mask_sens = filtered_df["highlights_lower"].str.contains("sensitive")
        filtered_df.loc[mask_sens, "score"] += 1

    # ---------- Ranking ----------
    filtered_df = filtered_df.sort_values(
        by=["score", "price_usd"],
        ascending=[False, True]
    )

    total_matches = len(filtered_df)

    # ---------- Mensajes ----------
    pretty_skin = skin_type or "your"
    if main_concerns:
        pretty_concerns = ", ".join(main_concerns)
    else:
        pretty_concerns = "your main concern"

    # ðŸ”¹ Texto de presupuesto con rango
    if min_price > 0 and max_price > 0:
        budget_text = f"${min_price}â€“${max_price}"
    elif max_price > 0:
        budget_text = f"under ${max_price}"
    elif min_price > 0:
        budget_text = f"from ${min_price}"
    else:
        budget_text = "N/A"

    header = (
        f"**Top 5 skincare recommendations for you**  \n"
        f"(Skin type: {pretty_skin}, "
        f"Main concern(s): {pretty_concerns}, "
        f"Budget: {budget_text})"
    )

    results = [header]

    if 0 < total_matches < 5:
        results.append(
            f"Only **{total_matches}** products matched your filters. Showing all available matches."
        )

    for rank, (_, row) in enumerate(filtered_df.head(5).iterrows(), start=1):
        ing_list = [x.strip() for x in str(row["ingredients"]).split(",") if x.strip()]
        key_ings = ", ".join(ing_list[:3]) if ing_list else "key skincare ingredients"

        explanation_main = pretty_concerns

        item = (
            f"{rank}) **{row['product_name']}** by *{row['brand_name']}* â€“ ${row['price_usd']}\n"
            f"Reason: Recommended for {pretty_skin} skin and {explanation_main}.\n"
            f"Contains key ingredients such as {key_ings}.\n"
            f"(Score: {row['score']})"
        )
        results.append(item)

    results.append(
        "_These recommendations are based on product data and tags and are not medical advice._"
    )

    return results
