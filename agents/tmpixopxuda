import os
import pandas as pd

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
CSV_PATH = os.path.join(BASE_DIR, "..", "knowledge_base", "product_info_slim.csv")

print(f"[Recommender] Loading product CSV from: {CSV_PATH}")

df = pd.read_csv(CSV_PATH)

df = df[[
    "brand_name",
    "product_name",
    "ingredients",
    "price_usd",
    "highlights",
    "primary_category",
    "secondary_category",
    "tertiary_category"
]]

# columnas preprocesadas para buscar más fácil
df["highlights_lower"] = df["highlights"].fillna("").str.lower()
df["ingredients_lower"] = df["ingredients"].fillna("").str.lower()


def recommender_agent(filters):
    print("[Recommender Agent] Selecting products with scoring...")

    skin_type      = (filters.get("skin_type") or "").lower()
    product_type   = (filters.get("product_type") or "").lower()
    budget         = float(filters.get("budget") or 0)
    main_concern   = (filters.get("main_concern") or "").lower()
    age_range      = (filters.get("age_range") or "").lower()
    needs_sensitive = bool(filters.get("needs_sensitive") or False)

    filtered_df = df.copy()

    # ---- Filtros “duros” ----
    # Product Type (cleanser, moisturizer, etc.)
    if product_type:
        mask_type = (
            filtered_df["primary_category"].fillna("").str.lower().str.contains(product_type) |
            filtered_df["secondary_category"].fillna("").str.lower().str.contains(product_type) |
            filtered_df["tertiary_category"].fillna("").str.lower().str.contains(product_type)
        )
        filtered_df = filtered_df[mask_type]

    # Budget (solo productos <= presupuesto)
    if budget > 0:
        filtered_df = filtered_df[filtered_df["price_usd"] <= budget]

    if filtered_df.empty:
        return ["No skincare products matched your filters. Try changing your budget or product type."]

    # ---- Scoring ----
    filtered_df["score"] = 0

    # +2 → Skin type match
    if skin_type:
        mask_skin = filtered_df["highlights_lower"].str.contains(skin_type)
        filtered_df.loc[mask_skin, "score"] += 2

    # +2 → Main concern (acne, hydration, redness, etc.)
    if main_concern:
        mask_concern = (
            filtered_df["highlights_lower"].str.contains(main_concern) |
            filtered_df["ingredients_lower"].str.contains(main_concern)
        )
        filtered_df.loc[mask_concern, "score"] += 2

    # +1 → Price ≤ 80% del budget
    if budget > 0:
        mask_cheap = filtered_df["price_usd"] <= budget * 0.8
        filtered_df.loc[mask_cheap, "score"] += 1

    # +1 → Age range o “all ages” en highlights (si lo tuvieras en el CSV)
    if age_range:
        mask_age = (
            filtered_df["highlights_lower"].str.contains(age_range) |
            filtered_df["highlights_lower"].str.contains("all ages")
        )
        filtered_df.loc[mask_age, "score"] += 1

    # +1 → Suitable for sensitive skin
    if needs_sensitive:
        mask_sens = filtered_df["highlights_lower"].str.contains("sensitive")
        filtered_df.loc[mask_sens, "score"] += 1

    # ---- Ranking: mayor score, y si empatan, más barato primero ----
    filtered_df = filtered_df.sort_values(
        by=["score", "price_usd"],
        ascending=[False, True]
    )

    # ---- Construir mensajes (Top 5) ----
    results = []
    for rank, (_, row) in enumerate(filtered_df.head(5).iterrows(), start=1):
        # tomar algunos ingredientes para mostrar
        ing_list = [x.strip() for x in str(row["ingredients"]).split(",") if x.strip()]
        key_ings = ", ".join(ing_list[:3]) if ing_list else "key skincare ingredients"

        explanation_main = main_concern if main_concern else "your main skin concern"

        item = (
            f"{rank}) **{row['product_name']}** by *{row['brand_name']}* – ${row['price_usd']}\n"
            f"Reason: Recommended for {skin_type or 'your'} skin and {explanation_main}.\n"
            f"Contains key ingredients such as {key_ings}.\n"
            f"(Score: {row['score']})"
        )
        results.append(item)

    return results
